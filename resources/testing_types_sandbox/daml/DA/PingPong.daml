module DA.PingPong where

data PingPongKey = PingPongKey
  with
    sender : Party
    count : Int
  deriving (Eq, Show)

data UserData = UserData
  with
    name: Party
    new_value: Int
  deriving (Show, Eq)

template Ping
  with
    sender: Party
    receiver: Party
    count: Int
  where
    signatory sender
    observer receiver
    key PingPongKey with .. : PingPongKey
    maintainer key.sender

    controller receiver can
      RespondPong : ()
        do
          if count > 10 then return ()
          else do
            create Pong with sender = receiver; receiver = sender; count = count + 1
            return ()

    controller sender can
      ResetPingCount : ()
        do
          create Ping with sender; receiver; count
          return ()
      FromUserData : ()
        with
            new_count: Int
            new_data: UserData
        do
          create Ping with sender; receiver; count = new_count + new_data.new_value
          return ()

template Pong
  with
    sender: Party
    receiver: Party
    count: Int
  where
    signatory sender
    observer receiver
    key PingPongKey with .. : PingPongKey
    maintainer key.sender

    controller receiver can
      RespondPing : ()
        do
          if count > 10 then return ()
          else do
            create Ping with sender = receiver; receiver = sender; count = count + 1
            return ()

    controller sender can
      ResetPongCount : ()
        with
            new_count: Int
        do
          create Pong with sender; receiver; count = new_count
          return ()